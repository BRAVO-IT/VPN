#!/bin/bash
# Homepage: https://github.com/BRAVO-IT/WireGuard
# Author: BRAVO_IT

# Detect external IP
function get_external_address() {
    local addr=$(timeout 3 dig +short myip.opendns.com @resolver1.opendns.com || \
    timeout 3 curl -s http://ipecho.net/plain || \
    timeout 3 curl -s http://ident.me/ || \
    timeout 3 curl -s http://whatismyip.akamai.com/)
    [ $? -ne 0 ] && addr="<this server IP address>"
    echo "$addr"
}

# Detect external interface
function get_external_iface() {
    ip route get 8.8.8.8 | grep -oP '(?<=dev )\S+'
}

# Generate WireGuard keys
function generate_keys() {
    umask 077
    wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
    wg genkey | tee /etc/wireguard/client_private.key | wg pubkey > /etc/wireguard/client_public.key
}

# Generate server config
function generate_server_config() {
cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
Address = 10.0.0.1/24
ListenPort = $PORT
PrivateKey = $(cat /etc/wireguard/server_private.key)
MTU = 1420

# Performance tuning
PostUp   = sysctl -w net.ipv4.ip_forward=1
PostUp   = sysctl -w net.ipv6.conf.all.forwarding=1
PostUp   = iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o $(get_external_iface) -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o $(get_external_iface) -j MASQUERADE

[Peer]
PublicKey = $(cat /etc/wireguard/client_public.key)
AllowedIPs = 10.0.0.2/32
PersistentKeepalive = 25
EOF
}

# Generate client config
function generate_client_config() {
cat > /etc/wireguard/client.conf <<EOF
[Interface]
Address = 10.0.0.2/32
PrivateKey = $(cat /etc/wireguard/client_private.key)
DNS = 8.8.8.8
MTU = 1420

[Peer]
PublicKey = $(cat /etc/wireguard/server_public.key)
Endpoint = $(get_external_address):$PORT
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
EOF
}

# Firewall rules
function configure_firewall() {
    local iface=$(get_external_iface)

    if which ufw > /dev/null; then
        ufw allow "$PORT"/udp
        if ! grep -q "WireGuard NAT" /etc/ufw/before.rules; then
            sed -i "1i # WireGuard NAT rules\n*nat\n:POSTROUTING ACCEPT [0:0]\n-A POSTROUTING -s 10.0.0.0/24 -o $iface -j MASQUERADE\nCOMMIT\n" /etc/ufw/before.rules
        fi
        ufw reload
    else
        iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o "$iface" -j MASQUERADE
    fi
}

# Enable IP forwarding + performance tuning
function enable_ip_forwarding() {
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
}

# Defaults
[ -z "$PORT" ] && export PORT=51820

# Install WireGuard
if [ -e /etc/os-release ]; then
    source /etc/os-release
    if [[ "$ID" == "ubuntu" || "$ID" == "debian" ]]; then
        apt update
        apt install -y wireguard wireguard-tools
    elif [[ "$ID" == "centos" || "$ID" == "rocky" || "$ID" == "almalinux" ]]; then
        yum install -y epel-release
        yum install -y wireguard-tools
    else
        echo "Unsupported distribution"
        exit 1
    fi
fi

# Generate configs
generate_keys
generate_server_config
generate_client_config
enable_ip_forwarding
configure_firewall

# Enable service
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0

echo
