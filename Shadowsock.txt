#!/bin/bash
# Homepage: https://github.com/BRAVO-IT/VPN
# Author: BRAVO_IT

function get_external_address() {
    local addr=$( timeout 3 curl -s http://ipecho.net/plain || \
                  timeout 3 curl -s http://ident.me/ || \
                  timeout 3 curl -s http://whatismyip.akamai.com/ )
    [ $? -ne 0 ] && addr="<this server IP address>"
    echo "$addr"
}

# Default proxy credentials
PASSWORD=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 12)

# Install Docker
function install_docker() {
    echo "Installing Docker..."
    curl -fsSL https://get.docker.com | bash
    systemctl enable docker
    systemctl start docker
}

# Pull Shadowsocks Docker Image
function pull_shadowsocks_image() {
    echo "Pulling Shadowsocks Docker image..."
    docker pull teddysun/shadowsocks-libev
}

# Run Shadowsocks Container
function run_shadowsocks() {
    echo "Starting Shadowsocks server..."
    docker run -d --name ss-server \
      -p 8388:8388/tcp \
      -p 8388:8388/udp \
      teddysun/shadowsocks-libev \
      -s 0.0.0.0 -p 8388 -k "$PASSWORD" -m aes-256-gcm
}

# Check if Shadowsocks is running
function verify_shadowsocks() {
    echo "Verifying Shadowsocks service..."
    docker ps
    docker logs ss-server
    netstat -tulnp | grep 8388
}

install_docker
pull_shadowsocks_image
run_shadowsocks
verify_shadowsocks

# Print Node Information
echo "Your Shadowsocks Proxy Configuration:"
echo "Protocol  : Shadowsocks"
echo "Address   : $(get_external_address)"
echo "Port      : 8388"
echo "Password  : $PASSWORD"
echo "Encryption: AES-256-GCM"
